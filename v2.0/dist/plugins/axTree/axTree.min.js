/*!
 *Last modified: 2022-09-06 16:49:43
 *名称: axTree.js
 *简介: tree树菜单的js文件
 *用法: new axTree('#id',{参数})
 *版本: v1.0.0
 *演示: https://www.axui.cn/v2.0/ax-tree.php
 *客服: 3217728223@qq.com
 *交流: QQ群952502085
 *作者: AXUI团队
 */
class e{constructor(e,t){this.targetDom=axIdToDom(e),this.options=axExtend({toggle:!0,collapse:!0,disabled:[],expand:[],checked:[],selected:"",oneSelected:!0,arrowIcon:["ax-icon-right","ax-icon-right","ax-none"],parentIcon:["ax-icon-folder","ax-icon-folder-open"],childIcon:"ax-icon-file-text",iconShow:!1,checkboxIcon:["ax-icon-square","ax-icon-check-s","ax-icon-check-s-f"],radioIcon:["ax-icon-circle","ax-icon-radio","ax-icon-radio-f"],checkShow:!1,checkType:"checkbox",checkMin:0,checkMax:1e6,linkage:!0,oneRadio:!1,readonly:"",url:"",cookie:"",inputWidth:"",toolsShow:!1,toolsAction:"hover",addTools:[],firstFloor:0,draggable:!1,line:!1,data:"",async:"",delay:0,fields:"",removeBefore:function(e,t){return!0},remove:function(e){},getCheckeds:function(e,t){}},t,this.targetDom),this.handlers={},this.checked=[],this.checkeds=[],this.expand=[],this.expands=[],this.selected=this.options.selected,this.options.oneSelected&&!axIsEmpty(this.selected)&&this.selected.shift(),this.selecteds=[],this.disabled=this.options.disabled,this.disableds=[],this.searchs=[],this.readonlys=[],this.arrowSame=this.options.arrowIcon[0]==this.options.arrowIcon[1],this.arrow=axAddElem("i",{class:"ax-arrow ax-iconfont"}),this.checkIcon={checkbox:['<i class="ax-check ax-iconfont '+this.options.checkboxIcon[0]+'"></i>','<i class="ax-check ax-iconfont '+this.options.checkboxIcon[1]+'"></i>','<i class="ax-check ax-iconfont '+this.options.checkboxIcon[2]+'"></i>'],radio:['<i class="ax-check ax-iconfont '+this.options.radioIcon[0]+'"></i>','<i class="ax-check ax-iconfont '+this.options.radioIcon[1]+'"></i>','<i class="ax-check ax-iconfont '+this.options.radioIcon[2]+'"></i>']},this.fileIcon="",this.options.iconShow&&(this.fileIcon={parent:'<i class="ax-type ax-iconfont '+this.options.parentIcon[0]+'"></i>',child:'<i class="ax-type ax-iconfont '+this.options.childIcon+'"></i>'}),this.maxFloor=0,this.init()}init(){let e=this;"String"==axType(this.options.data)&&this.options.async?"json"==this.options.async?axAjax({url:this.options.data,success:function(t){e.toTree(t),e.targetDom.innerHTML="",e.dataProcess(e.treeData)}},this.targetDom):"sql"==this.options.async&&axAjax({data:{pId:e.options.firstFloor},url:this.options.data,success:function(t){e.toTree(t),e.targetDom.innerHTML="",e.dataProcess(e.treeData)}},this.targetDom):("Array"==axType(this.options.data)?this.toTree(this.options.data):1!=this.options.data.nodeType&&"#"!=this.options.data.substr(0,1)||(this.treeData=axUlToArr(this.options.data,this.options.firstFloor+1,!0),this.targetDom.innerHTML=""),this.dataProcess(this.treeData))}toTree(e){e[0].hasOwnProperty("pId")?this.treeData=axArrToTree(e,this.options.firstFloor):this.treeData=e}newItemStart(e){let t,i=[];return e.forEach(e=>{i.push(e.id)}),t=Math.max(...i)+1,t}dataProcess(e){let t=this;if(this.flatData=this.flatTree(e),this.newItemStart(this.flatData),this.setAttribute(),!this.fixChecked(this.flatData))return!1;this.refreshTree(e),this.fixExpand(this.flatData),this.arrayToDom(e),this.flatData.forEach(e=>{axIsEmpty(this.expand)&&!this.options.collapse&&e.children&&(e.expand=!1,this.ulToggle(e)),this.renderFinish(e,t.flatData)}),"init"in t.handlers&&t.emit("init","")}setAttribute(){this.options.line&&this.targetDom.setAttribute("line","")}dragPlace(e,t){let i=t.getBoundingClientRect().top,s=t.getBoundingClientRect().bottom,o=(t.getBoundingClientRect().bottom-t.getBoundingClientRect().top)/3,a=i+~~o,n=s-~~o,h="child";return e.clientY<a?h="up":e.clientY>n&&(h="down"),h}resetRelation(e,t,i,s){let o=(e,t)=>{"1-0"==s?(e.pId=this.options.firstFloor,e.path=this.options.firstFloor+"-"+e.id,e.floor=1,e.dom.querySelector(".ax-indent").innerHTML=""):"0-1"!=s&&"other"!=s&&s||(e.pId=t.id,e.path=t.path+"-"+e.id,e.floor=t.floor+1,e.dom.querySelector(".ax-indent").innerHTML="<i></i>".repeat(e.floor-1))},a=(e,t)=>{e.children&&e.children.length>0?e.children.forEach(t=>{o(t,e),a(t,e)}):o(e,t)};o(e,t),a(e,t),"0-1"==s?this.treeData=this.treeData.filter(t=>t.id!=e.id):"0-0"==s||"1-0"==s||(i.children=i.children.filter(t=>t.id!=e.id))}openParentBorn(e,t,i,s){let o=e.dom.nextElementSibling;if(t){let a=t.dom.parentElement;this.resetRelation(t,e,i,s),e.expand||(e.dom.setAttribute("expand","true"),e.expand=!0,o.style.display="block"),e.children.unshift(t),o.insertAdjacentElement("afterBegin",a)}}childToParentBorn(e,t,i,s){let o=this;if(e.children)return!1;{let a=axAddElem("ul",{style:"display:block"}),n=e.dom.querySelector(".ax-arrow");if(n.classList.remove(this.options.arrowIcon[2]),n.classList.add(this.options.arrowIcon[0]),e.dom.setAttribute("expand","true"),e.expand=!0,e.children=[],t){let o=t.dom.parentElement;this.resetRelation(t,e,i,s),e.children.unshift(t),a.insertAdjacentElement("afterBegin",o)}e.dom.insertAdjacentElement("afterEnd",a),n.onclick=function(){o.ulToggle(e)}}}dropItem(e,t,i,s,o){let a=t.dom,n=a.parentElement,h=this.flatData.filter(t=>e.pId==t.id.toString())[0],c=e.dom.parentElement,l="up"==s?"beforeBegin":"down"==s?"afterEnd":"",r=s=>{if(this.resetRelation(t,h,i,o),"0-0"==o){let i=this.treeData.indexOf(t),o=this.treeData.indexOf(e);"up"==s?axMoveArr(this.treeData,i,o):"down"==s&&axMoveArr(this.treeData,i,o+1)}else if("1-0"==o){let i,o=this.treeData.indexOf(e);"up"==s?i=o:"down"==s&&(i=o+1),this.treeData.splice(i,0,t)}else{let i,o=h.children.indexOf(e);"up"==s?i=o:"down"==s&&(i=o+1),h.children.splice(i,0,t)}c.insertAdjacentElement(l,n)};if("up"==s){if(c.previousElementSibling==n)return!1;r("up")}else if("down"==s){if(c.nextElementSibling==n)return!1;r("down")}else e.children?this.openParentBorn(e,t,i,o):this.childToParentBorn(e,t,i,o);a.setAttribute("tabindex","-1"),a.focus(),a.onblur=function(){a.removeAttribute("tabindex")},"dropped"in this.handlers&&this.emit("dropped",e,t)}ulToggle(e,t=!0){let i=this,s=e.dom,o=s.querySelector(".ax-arrow"),a=s.querySelector(".ax-type"),n=s.nextElementSibling;1==e.expand?(e.expand=!1,s.removeAttribute("expand"),this.arrowSame||(o.classList.remove(this.options.arrowIcon[1]),o.classList.add(this.options.arrowIcon[0])),this.options.iconShow&&(a.classList.remove(this.options.parentIcon[1]),a.classList.add(this.options.parentIcon[0])),this.eachExapand(e),axSlideUp(n),"collapse"in i.handlers&&i.emit("collapse",e)):(e.expand=!0,s.setAttribute("expand","true"),this.arrowSame||(o.classList.remove(this.options.arrowIcon[0]),o.classList.add(this.options.arrowIcon[1])),this.options.iconShow&&(a.classList.remove(this.options.parentIcon[0]),a.classList.add(this.options.parentIcon[1])),this.eachExapand(e),axSlideDown(n),"expand"in i.handlers&&i.emit("expand",e),t&&this.siblingsCollapse(this.flatData,e))}clickCheck(e,t){let i=this,s=e.dom.querySelector(".ax-check");s.onclick=function(){if(!s||e.disabled)return!1;if(i.checkeds.length>i.options.checkMax&&!e.checked)return console.warn("The length of checked is too much!"),"tooMuch"in i.handlers&&i.emit("tooMuch",i.checkeds.length,i.options.checkMax),!1;if("checkbox"==i.options.checkType)1==e.checked?e.checked=!1:e.checked=!0,i.eachCheckbox(e,i.options.linkage),i.options.getCheckeds&&i.options.getCheckeds.call(i,e,i.checkeds);else if("radio"==i.options.checkType){if(t.filter(t=>t.pId==e.pId).some(e=>1==e.checked&&1==e.disabled))return console.warn("You must uncheck the disabled item that have been checked!"),!1;if(i.options.oneRadio&&t.some(e=>1==e.checked&&1==e.disabled))return console.warn("You must uncheck the disabled item that have been checked!"),!1;1==e.checked?e.checked=!1:e.checked=!0,i.eachRadio(e,i.options.linkage),i.options.getCheckeds&&i.options.getCheckeds.call(i,e,i.checkeds)}"clickCheck"in i.handlers&&i.emit("clickCheck",e,i.checkeds)}}siblingsCollapse(e,t){if(this.options.toggle){let i=e.filter(e=>e.pId==t.pId&&e.children&&e!=t);for(let e=0,t=i.length;e<t;e++){let t=i[e];t.dom.nextElementSibling&&(t.expand=!0,this.ulToggle(t))}}}renderFinish(e,t){let i,s,o,a,n=this,h=e.dom,c=h.parentElement,l=h.querySelector(".ax-arrow"),r=h.querySelector(".ax-name");l.classList.contains(this.options.arrowIcon[2])||(l.onclick=function(){if(!e.expand&&"sql"==n.options.async){let t=h.nextElementSibling;t||(t=axAddElem("ul"),h.insertAdjacentElement("afterEnd",t)),t.querySelector("li")||axAjax({data:{pId:e.id},url:n.options.data,before:function(){l.setAttribute("loading","")},success:function(i){l.removeAttribute("loading"),t.innerHTML="",i.forEach(t=>{n.add(e,t,"child","end")})}})}n.ulToggle(e)}),this.selected.includes(e.id)&&(e.selected=!0,this.eachSelect(e)),this.options.checkShow&&(this.disabled.includes(e.id)&&(e.disabled=!0,this.eachDisabled(e)),this.checked.includes(e.id)&&(e.checked=!0,"checkbox"==this.options.checkType?this.eachCheckbox(e,this.options.linkage):"radio"==this.options.checkType&&this.eachRadio(e,this.options.linkage)),this.clickCheck(e,t)),this.options.toolsShow&&(i=e.dom.querySelector(".ax-tools"),s=i.querySelector("[add]"),o=i.querySelector("[edit]"),a=i.querySelector("[remove]"),a.onclick=function(){if(e.readonly)return!1;1==n.options.removeBefore.call(n,e,a)&&n.remove(e)},o.onclick=function(){if(e.readonly)return!1;n.edit(e)},s.onclick=function(){if(e.readonly)return!1;n.add(e)}),r&&(r.onclick=function(){if(h.hasAttribute("editing"))return!1;let s=t.filter(t=>t!=e);1==e.selected?(e.selected=!1,n.eachSelect(e)):(e.selected=!0,n.eachSelect(e),n.options.oneSelected&&s.forEach(e=>{1==e.selected&&(e.selected=!1,n.eachSelect(e))}),"selected"in n.handlers&&n.emit("selected",e)),i&&"click"==n.options.toolsAction&&(e.selected?i.style.display="inline-block":i.style.display="none")},r.ondblclick=function(){if(e.readonly)return!1;n.edit(e)}),1==this.options.draggable?(c.setAttribute("draggable","true"),c.addEventListener("dragstart",(function(t){t.stopPropagation(),t.dataTransfer.effectAllowed="move",t.dataTransfer.setData("id",e.id)}),!1)):"Array"==axType(this.options.draggable)&&this.options.draggable.includes(e.id)&&(c.setAttribute("draggable","true"),c.addEventListener("dragstart",(function(t){t.stopPropagation(),t.dataTransfer.effectAllowed="move",t.dataTransfer.setData("id",e.id)}),!1)),h.addEventListener("dragenter",(function(e){e.preventDefault()}),!1),h.addEventListener("dragover",(function(e){e.preventDefault(),c.classList.add("ax-dragging"),c.setAttribute("insert",n.dragPlace(e,h))}),!1),h.addEventListener("dragleave",(function(e){e.preventDefault(),c.classList.remove("ax-dragging"),c.removeAttribute("insert")}),!1),h.addEventListener("drop",(function(t){t.preventDefault();let i,s=t.dataTransfer.getData("id"),o=n.flatData.filter(e=>s==e.id.toString())[0],a=n.flatData.filter(e=>o.pId==e.id)[0];if(i=e.pId==o.pId&&e.pId==n.options.firstFloor&&"child"!=n.dragPlace(t,h)?"0-0":e.pId==n.options.firstFloor&&"child"!=n.dragPlace(t,h)?"1-0":o.pId==n.options.firstFloor?"0-1":"other",c.classList.remove("ax-dragging"),c.removeAttribute("insert"),e==o)return!1;n.dropItem(e,o,a,n.dragPlace(t,h),i)}),!1)}getParents(e,t="obj"){let i=[],s=[];if("Array"==axType(e)){this.flatData.filter(t=>e.includes(t.id)).forEach(e=>{let t=e.path.split("-").filter(t=>t.id!=this.options.firstFloor&&t!=e.id);i.push(...t)})}else if("Object"==axType(e)){let t=e.path.split("-").filter(t=>t.id!=this.options.firstFloor&&t!=e.id);i.push(...t)}else{let t=this.flatData.filter(t=>t.id==e)[0],s=t.path.split("-").filter(e=>e.id!=this.options.firstFloor&&e!=t.id);i.push(...s)}return i=[...i].filter((e,t)=>[...i].indexOf(e)==t),i=i.map(Number),s=this.flatData.filter(e=>i.includes(e.id)),"obj"==t?s:"id"==t?i:{obj:s,id:i}}getChildren(e){let t=[];return"Array"==axType(e)?e.forEach(e=>{let i=this.flatData.filter(t=>t.path.includes("-"+e+"-"));t.push(...i)}):t="Object"==axType(e)?this.flatData.filter(t=>t.path.includes("-"+e.id+"-")):this.flatData.filter(t=>t.path.includes("-"+e+"-")),t}eachSelect(e){if(1==e.selected)e.dom.setAttribute("selected","true"),!this.selecteds.includes(e.id)&&this.selecteds.push(e.id);else{e.dom.removeAttribute("selected");for(let t=0;t<this.selecteds.length;t++)if(this.selecteds[t]==e.id){this.selecteds.splice(t,1);break}}}eachDisabled(e){let t=(e,t)=>{if(t)e.dom.setAttribute("disabled","true"),!this.disableds.includes(e.id)&&this.disableds.push(e.id);else{e.dom.removeAttribute("disabled");for(let t=0;t<this.disableds.length;t++)if(this.disableds[t]==e.id){this.disableds.splice(t,1);break}}},i=(e,s)=>{if(e.disabled=s,t(e,s),e.children&&e.children.length>0){[...e.children].filter(e=>!e.disabled).forEach(e=>{i(e,s)})}};1==e.disabled?(t(e,!0),"checkbox"==this.options.checkType&&i(e,!0)):(t(e,!1),"checkbox"==this.options.checkType&&i(e,!1))}eachExapand(e){if(1==e.expand)e.dom.setAttribute("expand","true"),!this.expands.includes(e.id)&&this.expands.push(e.id);else{e.dom.removeAttribute("expand");for(let t=0;t<this.expands.length;t++)if(this.expands[t]==e.id){this.expands.splice(t,1);break}}}checkToggle(e,t,i){let s=e.dom,o=s.querySelector(".ax-check"),a="checkbox"==i?"checkboxIcon":"radio"==i?"radioIcon":"";1==t?(e.checked=!0,s.setAttribute("checked","true"),o.classList.remove(this.options[a][0],this.options[a][1]),o.classList.add(this.options[a][2])):0==t?(e.checked=!1,s.setAttribute("checked","false"),o.classList.remove(this.options[a][1],this.options[a][2]),o.classList.add(this.options[a][0])):"ing"==t&&(e.checked="ing",s.setAttribute("checked","ing"),o.classList.remove(this.options[a][0],this.options[a][2]),o.classList.add(this.options[a][1]))}eachCheckbox(e,t){if(t){let t=e=>{e.children?1==e.checked?(this.checkToggle(e,!0,"checkbox"),e.children.forEach(e=>{e.disabled||(e.checked=!0,t(e))})):e.checked||(this.checkToggle(e,!1,"checkbox"),e.children.forEach(e=>{e.disabled||(e.checked=!1,t(e))})):1==e.checked?this.checkToggle(e,!0,"checkbox"):e.checked||this.checkToggle(e,!1,"checkbox")},i=e=>{let t=e.path.split("-").filter(t=>0!=t&&t!=e.id);this.flatData.filter(e=>t.includes(e.id.toString())).reverse().forEach(e=>{e.children.filter(e=>!e.disabled).every(e=>!e.checked)?this.checkToggle(e,!1,"checkbox"):e.children.filter(e=>!e.disabled).every(e=>1==e.checked)?this.checkToggle(e,!0,"checkbox"):e.children.some(e=>1==e.checked||"ing"==e.checked)&&this.checkToggle(e,"ing","checkbox")})};t(e),i(e)}else 1==e.checked?this.checkToggle(e,!0,"checkbox"):e.checked?this.checkToggle(e,"ing","checkbox"):this.checkToggle(e,!1,"checkbox");this.checkeds=[],this.flatData.filter(e=>1==e.checked).forEach(e=>{this.checkeds.push(e.id)}),this.checkeds.length>this.options.checkMax?(console.warn("The length of checked is too much!"),"tooMuch"in this.handlers&&this.emit("tooMuch",this.checkeds.length,this.options.checkMax)):this.checkeds.length<this.options.checkMin&&(console.warn("The length of checked is too little!"),"tooLittle"in this.handlers&&this.emit("tooLittle",this.checkeds.length,this.options.checkMin))}eachRadio(e,t){if(1==e.checked){let t=[];t=this.options.oneRadio?this.flatData.filter(t=>1==t.checked&&t!=e):this.flatData.filter(t=>t.pId==e.pId&&1==t.checked&&t!=e),t.forEach(e=>{this.checkToggle(e,!1,"radio")}),this.checkToggle(e,!0,"radio")}else this.checkToggle(e,!1,"radio");if(t){(()=>{let t=this.flatData.filter(e=>1==e.checked),i=[];t.forEach(e=>{let t=e.path.split("-").filter(t=>0!=t&&t!=e.id);i.push(...t)}),i=[...i].filter((function(e,t){return[...i].indexOf(e)==t}));let s=this.flatData.filter(e=>i.includes(e.id.toString()));this.flatData.filter(t=>t.children&&t!=e&&!t.checked).forEach(e=>{e.checked&&this.checkToggle(e,!1,"radio")}),axIsEmpty(s)||s.forEach(e=>{1==e.checked?this.checkToggle(e,!0,"radio"):this.checkToggle(e,"ing","radio")})})()}this.checkeds=[],this.flatData.filter(e=>1==e.checked).forEach(e=>{this.checkeds.push(e.id)})}arrange(e){let t=[];return e.forEach((i,s)=>{e.slice(s+1,e.length).forEach(e=>{let s=[];s=[i,e],t.push(s)})}),t}fixChecked(e){let t=!0;return this.options.checked.length>this.checkMax?(console.warn("The length of checked has been automatically intercepted!"),"tooMuch"in this.handlers&&this.emit("tooMuch",this.options.checked.length,this.checkMax),this.checked=this.options.checked.splice(this.checkMax)):this.checked=this.options.checked,this.checked.length<this.checkMin&&(console.error("The length of checked has exceeded the limit!"),"tooLittle"in this.handlers&&this.emit("tooLittle",this.checked.length,this.checkMin),t=!1),"radio"==this.options.checkType&&this.checked.length>1?(t=!this.arrange(this.checked).some(t=>e.find(e=>e.id==t[0]).pId==e.find(e=>e.id==t[1]).pId),t||console.error("Only one item can be selected at the same level!")):this.options.checkType,t}fixExpand(e){let t=[];e.forEach(e=>{let i=e.path.split("-").filter(e=>0!=e);if(this.options.expand.includes(~~i[i.length-1])&&t.push(...i),e.children&&e.children.length>0){let t=[];e.children.forEach(e=>{t.push(e.id)}),this.options.linkage&&(t.every(e=>this.checked.includes(e))?e.checked=!0:t.some(e=>this.checked.includes(e))&&(e.checked="ing"))}}),this.expand=t.filter((function(e,i){return t.indexOf(e)==i})),this.expand.forEach(t=>{let i=e.find(e=>t==e.id&&e.children);i&&(i.expand=!0)})}createItem(e,t){let i=this,s="";"checkbox"==i.options.checkType&&i.options.checkShow?e.hasOwnProperty("checked")?1==e.checked?s=i.checkIcon.checkbox[2]:"ing"==e.checked&&(s=i.checkIcon.checkbox[1]):s=i.checkIcon.checkbox[0]:"radio"==i.options.checkType&&i.options.checkShow&&(e.hasOwnProperty("checked")?1==e.checked?s=i.checkIcon.radio[2]:"ing"==e.checked&&(s=i.checkIcon.radio[1]):s=i.checkIcon.radio[0]);let o=`<i class="ax-arrow ${i.arrowSame?"":"ax-different"} ax-iconfont ${e.children?this.options.arrowIcon[0]:this.options.arrowIcon[2]}"></i>`,a=`\n                        <div class="ax-node" >\n                            <span class="ax-indent">${"<i></i>".repeat(t-1)}</span>\n                            ${o}\n                            ${s}\n                            <% if(this.children){ %>${i.fileIcon?i.fileIcon.parent:""}<% } else { %>${i.fileIcon?i.fileIcon.child:""} <% } %>\n                            <a class="ax-name"><% this.name %></a>\n                            ${i.options.toolsShow?'<span class="ax-tools"><i class="ax-iconfont ax-icon-plus" add></i><i class="ax-iconfont ax-icon-edit" edit></i><i class="ax-iconfont ax-icon-trash" remove></i></span>':""}\n                        </div>`,n=axStrToDom(axTplEngine(a,e));return axIsEmpty(this.options.addTools)||this.options.addTools.forEach(t=>{let s=axStrToDom(t.dom);s.onclick=function(){t.callback.call(i,e)},n.querySelector(".ax-tools").insertAdjacentElement("afterBegin",s)}),e.dom=n,n}addAttritue(e,t){t.setAttribute("mark",e.id),this.options.readonly.includes(e.id)&&this.readonly(e),this.eachExapand(e),this.options.toolsShow&&t.setAttribute("tools",this.options.toolsAction)}flatTree(e){let t=[];return[...e].forEach(e=>{e.children?t=[...t,e,...this.flatTree(e.children)]:t.push(e)}),this.flatData=[...t],this.flatData}refreshTree(e){let t=(e,i,s=this.options.firstFloor)=>{e.forEach(e=>{if(e.floor=i,e.pId=e.pId?e.pId:this.options.firstFloor,i>this.maxFloor&&(this.maxFloor=i),e.children&&e.children.length>0){let o;e.children.forEach(t=>{t.path="",t.path+=s.toString()+"-"+e.id.toString(),o=t.path,t.pId=e.id}),t(e.children,i+1,o)}e.path?e.path+="-"+e.id:e.path=e.pId+"-"+e.id})};return t(e,1),this.flatTree(e),e}arrayToDom(e){let t=axAddElem("ul"),i=document.createDocumentFragment(),s=(e,t)=>{let i=axAddElem("ul");return t.forEach(e=>{let t=this.createItem(e,e.floor),o=axAddElem("li");this.addAttritue(e,t),o.appendChild(t),e.hasOwnProperty("children")&&s(o,e.children),i.appendChild(o)}),e.appendChild(i),e};s(t,e),[...t.childNodes[0].childNodes].forEach(e=>{i.appendChild(e)}),this.targetDom.appendChild(i),[...this.targetDom.querySelectorAll("[expand]")].forEach(e=>{e.nextElementSibling.style.display="block"}),"planted"in this.handlers&&this.emit("planted","")}add(e,t,i="child",s="front",o){let a=this,n="object"==typeof e?e:this.flatData.filter(t=>t.id==e)[0],h=n.dom,c={};if(axIsEmpty(t)||"object"!=typeof t){let e=this.newItemStart(this.flatData),t="新节点"+e;c="child"==i?{id:e,name:t,pId:n.id,path:n.path+"-"+e,floor:n.floor+1}:{id:e,name:t,pId:n.pId,path:n.path.replace(new RegExp("(.*)"+n.id),"$1"+e),floor:n.floor}}else{let e="child"==i?{path:n.path+"-"+t.id,floor:n.floor+1}:{path:n.path.replace(new RegExp("(.*)"+n.id),"$1"+t.id),floor:n.floor};c=Object.assign(t,e)}c.dom=this.createItem(c,c.floor);let l=c.dom,r=axAddElem("li");if(this.addAttritue(c,l),r.appendChild(l),"child"==i)if(n.children){"front"==s?n.children.unshift(c):n.children.push(c),h.nextElementSibling.insertAdjacentElement("front"==s?"afterBegin":"beforeEnd",r),this.flatData.push(c),n.expand||this.ulToggle(n)}else{n.children=[],"front"==s?n.children.unshift(c):n.children.push(c);let e=h.querySelector(".ax-arrow"),t=axAddElem("ul",{style:"display:block"});e.classList.remove(this.options.arrowIcon[2]),e.classList.add(this.options.arrowIcon[0]),n.expand=!0,h.setAttribute("expand","true"),t.insertAdjacentElement("front"==s?"afterBegin":"beforeEnd",r),h.insertAdjacentElement("afterEnd",t),this.flatData.push(c),this.siblingsCollapse(this.flatData,n),e.onclick=function(){a.ulToggle(n)}}else{if("brother"!=i)return console.error("Node type must be filled correctly!"),!1;{let e=this.flatData.filter(e=>e.id==n.pId)[0],t=e?e.children:this.treeData,i=t.indexOf(n);"front"==s?0==i?t.unshift(c):t.splice(i,0,c):t.splice(i+1,0,c),h.parentElement.insertAdjacentElement("front"==s?"beforeBegin":"afterEnd",r),this.flatData.push(c),e&&!e.expand&&(e.expand=!0,this.ulToggle(e))}}return this.renderFinish(c,this.flatData),l.setAttribute("tabindex","-1"),l.focus(),l.onblur=function(){l.removeAttribute("tabindex")},"added"in a.handlers&&a.emit("added",n,c),o&&o.call(this,n,c),this}edit(e,t){let i="object"==typeof e?e:this.flatData.filter(t=>t.id==e)[0],s=i.dom,o=s.querySelector(".ax-name"),a=axAddElem("input",{type:"text"});return!s.hasAttribute("editing")&&(s.setAttribute("editing","true"),o.innerHTML="",o.appendChild(a),a.focus(),a.value=i.name,a.onblur=function(){s.removeAttribute("editing"),i.name=this.value,o.innerHTML=this.value},a.onkeyup=function(e){13==e.keyCode&&this.blur()},"edited"in this.handlers&&this.emit("edited",i),t&&t.call(this,i),this)}remove(e,t){let i="object"==typeof e?e:this.flatData.filter(t=>t.id==e)[0];if(i.dom.parentElement.remove(),i.pId&&i.pId!=this.options.firstFloor){let e=this.flatData.filter(e=>e.id==i.pId)[0].children,t=e.indexOf(i);e.splice(t,1)}else this.treeData=this.treeData.filter(e=>e!=i);return this.flatData=this.flatData.filter(e=>e!=i&&!e.path.includes("-"+i.id+"-")),"removed"in this.handlers&&this.emit("removed",i),t&&t.call(this,i),this}search(e,t){if(this.searchs.length>0){this.searchs.forEach(e=>{e.dom.querySelector(".ax-name").innerHTML=e.name}),this.treeData.filter(e=>"none"==e.dom.parentElement.style.display).forEach(e=>{e.dom.parentElement.removeAttribute("style")})}if(e){let t=[];this.searchs=this.flatData.filter(t=>t.name.includes(e)),this.searchs,this.searchs.forEach(i=>{t.push(i.id);let s=i.dom.querySelector(".ax-name"),o=s.innerHTML.replace(e,"<i>"+e+"</i>");s.innerHTML=o});let i=this.getParents(t,"both");i.obj.forEach(e=>{e.expand=!0,e.dom.setAttribute("expand","true"),e.dom.nextElementSibling.style.display="block"});let s=[];i.obj.forEach(e=>{let t=this.flatData.filter(t=>t.pId=e.pId&&t!=e);s.push(...t)}),i.id=[...i.id,...t];let o=this.treeData.filter(e=>!i.id.includes(e.id));s.push(...o),this.flatData.filter(e=>!s.includes(e)).forEach(e=>{e.dom.parentElement.removeAttribute("style")});for(let e=0,t=s.length;e<t;e++){let t=s[e];"none"!=t.dom.parentElement.style.display&&(t.dom.parentElement.style.display="none")}}else this.searchs=[],this.flatData.forEach(e=>{let t=e.dom.parentElement;"none"==t.style.display&&t.removeAttribute("style")});return"searched"in this.handlers&&this.emit("searched",this.searchs,e),t&&t.call(this,this.searchs,e),this}check(e,t=!0){let i;if("Array"==axType(e)){i=this.flatData.filter(t=>e.includes(t.id));for(let e=0,s=i.length;e<s;e++){let s=i[e];s.checked!=t&&(s.checked=t,"checkbox"==this.options.checkType?this.eachCheckbox(s,this.options.linkage):"radio"==this.options.checkType&&this.eachRadio(s,this.options.linkage))}}else{if(i=this.flatData.filter(t=>t.id==e),i.checked==t)return!1;i[0].checked=t,"checkbox"==this.options.checkType?this.eachCheckbox(i[0],this.options.linkage):"radio"==this.options.checkType&&this.eachRadio(i[0],this.options.linkage)}return"setChecked"in this.handlers&&this.emit("setChecked",i),this}disable(e,t=!0){let i;if("Array"==axType(e)){i=this.flatData.filter(t=>e.includes(t.id));let s=[];i.forEach(e=>{s.push(...this.getChildren(e))}),s=[...s].filter((e,t)=>[...s].indexOf(e)==t),i.push(...s);for(let e=0,o=i.length;e<o;e++){let o=i[e];o.disabled!=t&&(o.disabled=t,this.eachDisabled(o),s.forEach(e=>{e.disabled=t,this.eachDisabled(e)}))}}else{if(i.disabled==t)return!1;i=this.flatData.filter(t=>t.id==e),this.getChildren(i[0]).forEach(e=>{e.disabled=t,this.eachDisabled(e)})}return i.forEach(e=>{e.disabled=t,this.clickCheck(e,this.flatData)}),"setDisabled"in this.handlers&&this.emit("setDisabled",i),this}readonly(e,t=!0){let i=(e,t)=>{t?(e.readonly=!0,e.dom.setAttribute("readonly","true")):(e.readonly=!1,e.dom.removeAttribute("readonly"))},s=[];if("Array"==axType(e))s=this.flatData.filter(t=>e.includes(t.id)),s.forEach(e=>{i(e,t)});else if("Object"==axType(e))i(e,t),s.push(e);else{let o=this.flatData.filter(t=>t.id==e)[0];i(o,t),s.push(o)}return this.readonlys=[...this.readonlys,...s],this.readonlys=[...this.readonlys].filter((e,t)=>[...this.readonlys].indexOf(e)==t),"setReadonly"in this.handlers&&this.emit("setReadonly",s),this}expandAll(){let e=this.flatData.filter(e=>!e.expand&&e.children),t=[];return e.forEach(e=>{e.expand=!1,this.ulToggle(e,!1),t.push(e.id)}),this.expands=t,this}collapseAll(){return this.flatData.filter(e=>e.expand&&e.children).forEach(e=>{e.expand=!0,this.ulToggle(e,!1)}),this.expands=[],this}reset(){return this.targetDom.innerHTML="",this.init(),"reset"in this.handlers&&this.emit("reset",""),this}on(e,t){return axAddPlan(e,t,this),this}emit(e,...t){axExePlan(e,this,...t)}off(e,t){return axDelPlan(e,t,this),this}}document.querySelectorAll("[axTree]").forEach(t=>{new e(t,{data:t})});